<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHL Puckle - Trivia Game</title>
    <style>
        :root {
            --correct: #538d4e;
            --wrong: #3a3a3c;
            --bg: #121213;
            --text: #ffffff;
            --accent: #007bff;
            --panel: #1e1e1e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 400px; width: 100%; text-align: center; }

        /* Clue Card */
        .clue-box {
            background: var(--panel);
            border: 3px solid var(--accent);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        #player-img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: #333;
            margin: 15px 0;
            filter: blur(20px);
            transition: filter 0.5s ease;
            border: 4px solid #444;
        }

        .jersey-num { font-size: 80px; font-weight: bold; color: var(--accent); line-height: 1; }
        .team-label { font-size: 20px; font-weight: bold; letter-spacing: 2px; }

        /* Controls */
        select, input, button {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            box-sizing: border-box;
        }

        select, input { background: #272729; color: white; border: 1px solid #444; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        
        button { cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-guess { background: var(--correct); color: white; grid-column: span 2; }
        .btn-giveup { background: #e74c3c; color: white; }
        .btn-reset { background: var(--accent); color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* History */
        #history { margin-top: 20px; width: 100%; }
        .history-item {
            background: var(--wrong);
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h1>üèí NHL PUCKLE</h1>

    <select id="team-select" onchange="resetGame()">
        <option value="ALL">All Teams</option>
        <optgroup label="Atlantic">
            <option value="BOS">Boston Bruins</option><option value="BUF">Buffalo Sabres</option>
            <option value="DET">Detroit Red Wings</option><option value="FLA">Florida Panthers</option>
            <option value="MTL">Montreal Canadiens</option><option value="OTT">Ottawa Senators</option>
            <option value="TBL">Tampa Bay Lightning</option><option value="TOR">Toronto Maple Leafs</option>
        </optgroup>
        <optgroup label="Metropolitan">
            <option value="CAR">Carolina Hurricanes</option><option value="CBJ">Columbus Blue Jackets</option>
            <option value="NJD">New Jersey Devils</option><option value="NYI">New York Islanders</option>
            <option value="NYR">New York Rangers</option><option value="PHI">Philadelphia Flyers</option>
            <option value="PIT">Pittsburgh Penguins</option><option value="WSH">Washington Capitals</option>
        </optgroup>
        <optgroup label="Central">
            <option value="CHI">Chicago Blackhawks</option><option value="COL">Colorado Avalanche</option>
            <option value="DAL">Dallas Stars</option><option value="MIN">Minnesota Wild</option>
            <option value="NSH">Nashville Predators</option><option value="STL">St. Louis Blues</option>
            <option value="UTA">Utah Mammoth</option><option value="WPG">Winnipeg Jets</option>
        </optgroup>
        <optgroup label="Pacific">
            <option value="ANA">Anaheim Ducks</option><option value="CGY">Calgary Flames</option>
            <option value="EDM">Edmonton Oilers</option><option value="LAK">Los Angeles Kings</option>
            <option value="SJS">San Jose Sharks</option><option value="SEA">Seattle Kraken</option>
            <option value="VAN">Vancouver Canucks</option><option value="VGK">Vegas Golden Knights</option>
        </optgroup>
    </select>

    <div class="clue-box">
        <div id="display-team" class="team-label">LOADING...</div>
        <div id="display-number" class="jersey-num">--</div>
        <img id="player-img" src="">
        <div id="display-pos" style="font-weight: bold; color: #aaa;">POSITION</div>
    </div>

    <div style="margin-bottom: 10px;">Guesses Left: <strong id="guesses-left">5</strong></div>

    <input type="text" id="guess-input" list="player-options" placeholder="Type player name..." oninput="fetchSuggestions()">
    <datalist id="player-options"></datalist>

    <button onclick="submitGuess()" id="guess-btn" class="btn-guess">SUBMIT GUESS</button>
    
    <div class="btn-group">
        <button onclick="revealAnswer(false)" id="give-up-btn" class="btn-giveup">GIVE UP</button>
        <button onclick="resetGame()" id="reset-btn" class="btn-reset">NEW PLAYER</button>
    </div>

    <div id="history"></div>
</div>

<script>
    let target = null;
    let attempts = 0;
    let isOver = false;

    async function initGame() {
        const team = document.getElementById('team-select').value;
        const res = await fetch(`/daily-player?team=${team}`);
        if (!res.ok) {
            alert("Could not find a player for that team!");
            return;
        }
        target = await res.json();
        
        // Update UI
        document.getElementById('display-team').innerText = target.team;
        document.getElementById('display-number').innerText = target.jersey;
        document.getElementById('display-pos').innerText = target.position;
        document.getElementById('player-img').src = target.image;
        document.getElementById('player-img').style.filter = "blur(20px)";
    }

    async function fetchSuggestions() {
        const q = document.getElementById('guess-input').value;
        const team = document.getElementById('team-select').value;
        if (q.length < 2) return;

        const res = await fetch(`/search-players?q=${q}&team=${team}`);
        const players = await res.json();
        const list = document.getElementById('player-options');
        list.innerHTML = "";
        players.forEach(p => {
            const o = document.createElement('option');
            o.value = p.name;
            list.appendChild(o);
        });
    }

    function submitGuess() {
        if (isOver) return;
        const input = document.getElementById('guess-input');
        const val = input.value.trim();
        if (!val) return;

        attempts++;
        const correct = val.toLowerCase() === target.name.toLowerCase();
        
        // Progressive unblur logic (20px -> 16 -> 12 -> 8 -> 4 -> 0)
        const newBlur = Math.max(0, 20 - (attempts * 4));
        document.getElementById('player-img').style.filter = `blur(${newBlur}px)`;

        // Update History
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `<span>${val}</span> <span>${correct ? '‚úÖ' : '‚ùå'}</span>`;
        document.getElementById('history').prepend(item);

        document.getElementById('guesses-left').innerText = 5 - attempts;
        input.value = "";

        if (correct) {
            endGame(true);
        } else if (attempts >= 5) {
            revealAnswer(true);
        }
    }

    function revealAnswer(ranOut) {
        endGame(false, ranOut ? "Out of guesses!" : "You gave up!");
    }

    function endGame(won, msg) {
        isOver = true;
        document.getElementById('player-img').style.filter = "none";
        document.getElementById('guess-input').disabled = true;
        document.getElementById('guess-btn').disabled = true;
        document.getElementById('give-up-btn').disabled = true;
        
        setTimeout(() => {
            alert(won ? "üèÜ GOAL! You guessed it!" : `${msg} The player was ${target.name}`);
        }, 500);
    }

    function resetGame() {
        attempts = 0;
        isOver = false;
        document.getElementById('history').innerHTML = "";
        document.getElementById('guesses-left').innerText = "5";
        document.getElementById('guess-input').disabled = false;
        document.getElementById('guess-btn').disabled = false;
        document.getElementById('give-up-btn').disabled = false;
        document.getElementById('guess-input').value = "";
        initGame();
    }

    // Initial load
    initGame();
</script>

</body>
</html>
